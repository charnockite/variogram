testDataBig = [{"x":466,"y":481,"value":1},{"x":45,"y":354,"value":11},{"x":34,"y":973,"value":1},{"x":997,"y":223,"value":6},{"x":872,"y":642,"value":6},{"x":78,"y":869,"value":20},{"x":624,"y":455,"value":14},{"x":44,"y":977,"value":16},{"x":798,"y":625,"value":11},{"x":79,"y":523,"value":14},{"x":245,"y":677,"value":13},{"x":722,"y":335,"value":14},{"x":195,"y":309,"value":9},{"x":221,"y":467,"value":5},{"x":900,"y":278,"value":4},{"x":980,"y":534,"value":10},{"x":88,"y":549,"value":19},{"x":351,"y":417,"value":5},{"x":864,"y":590,"value":16},{"x":133,"y":26,"value":1},{"x":593,"y":519,"value":11},{"x":981,"y":974,"value":5},{"x":672,"y":48,"value":1},{"x":807,"y":862,"value":5},{"x":275,"y":653,"value":3},{"x":515,"y":181,"value":2},{"x":713,"y":450,"value":8},{"x":783,"y":694,"value":15},{"x":84,"y":320,"value":9},{"x":727,"y":240,"value":3},{"x":290,"y":299,"value":12},{"x":417,"y":625,"value":2},{"x":280,"y":125,"value":6},{"x":958,"y":55,"value":14},{"x":665,"y":756,"value":15},{"x":269,"y":369,"value":19},{"x":661,"y":22,"value":14},{"x":362,"y":257,"value":7},{"x":940,"y":246,"value":18},{"x":477,"y":22,"value":9},{"x":377,"y":565,"value":12},{"x":626,"y":318,"value":16},{"x":530,"y":800,"value":11},{"x":95,"y":168,"value":4},{"x":676,"y":621,"value":15},{"x":137,"y":493,"value":17},{"x":445,"y":388,"value":14},{"x":181,"y":97,"value":20},{"x":112,"y":680,"value":3},{"x":407,"y":527,"value":5},{"x":720,"y":243,"value":15},{"x":784,"y":482,"value":1},{"x":991,"y":584,"value":7},{"x":713,"y":325,"value":4},{"x":994,"y":24,"value":18},{"x":242,"y":126,"value":19},{"x":168,"y":6,"value":5},{"x":517,"y":216,"value":18},{"x":518,"y":80,"value":8},{"x":274,"y":156,"value":5},{"x":814,"y":378,"value":18},{"x":32,"y":864,"value":14},{"x":743,"y":673,"value":1},{"x":254,"y":457,"value":1},{"x":214,"y":158,"value":4},{"x":573,"y":487,"value":15},{"x":88,"y":44,"value":19},{"x":856,"y":135,"value":15},{"x":398,"y":388,"value":1},{"x":852,"y":716,"value":3},{"x":564,"y":556,"value":19},{"x":827,"y":384,"value":2},{"x":48,"y":381,"value":18},{"x":333,"y":134,"value":15},{"x":563,"y":797,"value":18},{"x":152,"y":292,"value":15},{"x":1,"y":103,"value":4},{"x":973,"y":467,"value":10},{"x":373,"y":628,"value":10},{"x":111,"y":937,"value":20},{"x":556,"y":410,"value":4},{"x":268,"y":253,"value":1},{"x":813,"y":461,"value":10},{"x":922,"y":442,"value":12},{"x":797,"y":711,"value":3},{"x":524,"y":946,"value":11},{"x":809,"y":829,"value":8},{"x":620,"y":670,"value":8},{"x":289,"y":895,"value":19},{"x":442,"y":473,"value":2},{"x":769,"y":336,"value":18},{"x":671,"y":751,"value":2},{"x":632,"y":484,"value":3},{"x":864,"y":539,"value":9},{"x":219,"y":518,"value":15},{"x":463,"y":815,"value":16},{"x":711,"y":909,"value":19},{"x":381,"y":254,"value":8},{"x":385,"y":853,"value":2},{"x":366,"y":34,"value":20},{"x":826,"y":607,"value":11},{"x":908,"y":123,"value":18},{"x":196,"y":293,"value":9},{"x":400,"y":409,"value":7},{"x":386,"y":306,"value":20},{"x":899,"y":893,"value":9},{"x":611,"y":110,"value":9},{"x":736,"y":675,"value":2},{"x":399,"y":306,"value":10},{"x":986,"y":392,"value":14},{"x":129,"y":630,"value":9},{"x":340,"y":237,"value":16},{"x":677,"y":927,"value":14},{"x":52,"y":182,"value":18},{"x":967,"y":552,"value":16},{"x":931,"y":123,"value":3},{"x":424,"y":451,"value":14},{"x":531,"y":625,"value":15},{"x":524,"y":52,"value":7},{"x":164,"y":713,"value":13},{"x":726,"y":921,"value":12},{"x":706,"y":866,"value":8},{"x":592,"y":617,"value":4},{"x":556,"y":240,"value":13},{"x":405,"y":981,"value":13},{"x":177,"y":193,"value":7},{"x":51,"y":786,"value":4},{"x":34,"y":40,"value":15},{"x":768,"y":700,"value":17},{"x":381,"y":329,"value":2},{"x":857,"y":434,"value":12},{"x":341,"y":932,"value":1},{"x":851,"y":820,"value":2},{"x":102,"y":344,"value":3},{"x":564,"y":78,"value":13},{"x":545,"y":267,"value":12},{"x":74,"y":286,"value":5},{"x":349,"y":174,"value":20},{"x":904,"y":894,"value":3},{"x":944,"y":836,"value":18},{"x":466,"y":158,"value":9},{"x":676,"y":53,"value":12},{"x":561,"y":650,"value":1},{"x":378,"y":85,"value":19},{"x":65,"y":52,"value":1},{"x":172,"y":616,"value":14},{"x":721,"y":649,"value":10},{"x":668,"y":10,"value":2},{"x":635,"y":224,"value":18},{"x":746,"y":999,"value":7},{"x":834,"y":971,"value":4},{"x":331,"y":481,"value":6},{"x":379,"y":131,"value":4},{"x":124,"y":848,"value":9},{"x":597,"y":901,"value":12},{"x":95,"y":887,"value":10},{"x":93,"y":956,"value":15},{"x":128,"y":932,"value":19},{"x":260,"y":308,"value":19},{"x":873,"y":591,"value":14},{"x":949,"y":1,"value":11},{"x":215,"y":814,"value":12},{"x":72,"y":13,"value":1},{"x":899,"y":935,"value":13},{"x":982,"y":190,"value":16},{"x":146,"y":10,"value":6},{"x":1,"y":750,"value":8},{"x":586,"y":378,"value":18},{"x":382,"y":8,"value":13},{"x":745,"y":40,"value":12},{"x":744,"y":302,"value":13},{"x":342,"y":799,"value":11},{"x":682,"y":268,"value":9},{"x":253,"y":866,"value":6},{"x":556,"y":646,"value":13},{"x":171,"y":967,"value":18},{"x":174,"y":834,"value":9},{"x":600,"y":455,"value":1},{"x":505,"y":563,"value":14},{"x":240,"y":871,"value":7},{"x":107,"y":186,"value":1},{"x":113,"y":454,"value":20},{"x":419,"y":179,"value":3},{"x":860,"y":755,"value":11},{"x":561,"y":174,"value":18},{"x":738,"y":353,"value":19},{"x":116,"y":161,"value":11},{"x":374,"y":531,"value":7},{"x":378,"y":682,"value":14},{"x":668,"y":3,"value":16},{"x":322,"y":999,"value":7},{"x":403,"y":658,"value":11},{"x":40,"y":147,"value":8},{"x":561,"y":938,"value":16},{"x":177,"y":766,"value":8},{"x":640,"y":537,"value":13},{"x":21,"y":897,"value":2},{"x":45,"y":560,"value":10},{"x":281,"y":129,"value":14},{"x":5,"y":82,"value":11},{"x":877,"y":178,"value":18},{"x":123,"y":93,"value":2},{"x":865,"y":42,"value":7},{"x":433,"y":301,"value":14},{"x":150,"y":489,"value":19},{"x":371,"y":969,"value":8},{"x":936,"y":598,"value":2},{"x":848,"y":491,"value":19},{"x":103,"y":380,"value":16},{"x":373,"y":320,"value":15},{"x":60,"y":891,"value":2},{"x":31,"y":24,"value":15},{"x":252,"y":349,"value":18},{"x":809,"y":297,"value":11},{"x":914,"y":476,"value":17},{"x":84,"y":668,"value":20},{"x":842,"y":693,"value":10},{"x":882,"y":984,"value":3},{"x":694,"y":32,"value":6},{"x":988,"y":921,"value":7},{"x":540,"y":294,"value":10},{"x":396,"y":25,"value":5},{"x":191,"y":296,"value":17},{"x":454,"y":23,"value":6},{"x":966,"y":295,"value":4},{"x":760,"y":311,"value":15},{"x":432,"y":45,"value":12},{"x":800,"y":14,"value":14},{"x":6,"y":380,"value":1},{"x":525,"y":515,"value":3},{"x":695,"y":28,"value":7},{"x":879,"y":568,"value":14},{"x":403,"y":44,"value":8},{"x":701,"y":798,"value":8},{"x":52,"y":157,"value":8},{"x":365,"y":249,"value":2},{"x":612,"y":722,"value":7},{"x":107,"y":574,"value":3},{"x":602,"y":79,"value":4},{"x":711,"y":391,"value":8},{"x":633,"y":954,"value":4},{"x":359,"y":939,"value":4},{"x":121,"y":365,"value":19},{"x":976,"y":864,"value":8},{"x":277,"y":955,"value":17},{"x":774,"y":152,"value":11},{"x":100,"y":1,"value":3},{"x":491,"y":757,"value":18},{"x":145,"y":984,"value":9},{"x":514,"y":454,"value":14},{"x":819,"y":726,"value":12},{"x":878,"y":294,"value":10},{"x":590,"y":723,"value":14},{"x":673,"y":454,"value":6},{"x":566,"y":867,"value":17},{"x":366,"y":174,"value":9},{"x":936,"y":645,"value":20},{"x":707,"y":430,"value":3},{"x":20,"y":868,"value":12},{"x":646,"y":68,"value":5},{"x":394,"y":836,"value":14},{"x":695,"y":18,"value":8},{"x":384,"y":512,"value":13},{"x":553,"y":47,"value":19},{"x":303,"y":173,"value":3},{"x":319,"y":39,"value":11},{"x":998,"y":69,"value":10},{"x":897,"y":422,"value":14},{"x":691,"y":974,"value":17},{"x":190,"y":564,"value":8},{"x":927,"y":87,"value":14},{"x":486,"y":752,"value":1},{"x":513,"y":305,"value":9},{"x":266,"y":764,"value":17},{"x":334,"y":464,"value":17},{"x":88,"y":619,"value":13},{"x":504,"y":90,"value":14},{"x":514,"y":629,"value":20},{"x":376,"y":623,"value":18},{"x":523,"y":264,"value":12},{"x":98,"y":894,"value":20},{"x":785,"y":279,"value":12},{"x":914,"y":200,"value":13},{"x":424,"y":212,"value":11},{"x":642,"y":879,"value":16},{"x":969,"y":306,"value":6},{"x":404,"y":553,"value":17},{"x":370,"y":668,"value":9},{"x":869,"y":897,"value":13},{"x":986,"y":428,"value":12},{"x":95,"y":635,"value":5},{"x":131,"y":716,"value":1},{"x":509,"y":960,"value":15},{"x":966,"y":622,"value":2},{"x":924,"y":408,"value":13},{"x":585,"y":177,"value":15},{"x":887,"y":480,"value":4},{"x":142,"y":947,"value":17},{"x":415,"y":876,"value":17},{"x":613,"y":430,"value":4},{"x":399,"y":666,"value":2},{"x":481,"y":336,"value":2},{"x":401,"y":107,"value":14},{"x":813,"y":502,"value":15},{"x":991,"y":266,"value":18},{"x":900,"y":859,"value":16},{"x":432,"y":260,"value":2},{"x":237,"y":381,"value":10},{"x":932,"y":561,"value":9},{"x":136,"y":227,"value":8},{"x":450,"y":568,"value":8},{"x":643,"y":683,"value":9},{"x":624,"y":975,"value":11},{"x":862,"y":715,"value":8},{"x":575,"y":576,"value":14},{"x":783,"y":636,"value":18},{"x":546,"y":83,"value":8},{"x":468,"y":134,"value":19},{"x":699,"y":567,"value":13},{"x":205,"y":739,"value":12},{"x":39,"y":973,"value":18},{"x":254,"y":78,"value":13},{"x":81,"y":117,"value":16},{"x":799,"y":437,"value":12},{"x":230,"y":948,"value":16},{"x":214,"y":313,"value":17},{"x":149,"y":67,"value":11},{"x":918,"y":740,"value":11},{"x":151,"y":503,"value":20},{"x":610,"y":951,"value":20},{"x":402,"y":888,"value":17},{"x":388,"y":919,"value":11},{"x":894,"y":191,"value":6},{"x":704,"y":898,"value":18},{"x":523,"y":442,"value":14},{"x":996,"y":149,"value":10},{"x":598,"y":588,"value":9},{"x":677,"y":21,"value":16},{"x":666,"y":530,"value":18},{"x":173,"y":368,"value":8},{"x":53,"y":10,"value":10},{"x":646,"y":496,"value":14},{"x":305,"y":314,"value":19},{"x":635,"y":561,"value":10},{"x":790,"y":881,"value":5},{"x":1,"y":948,"value":15},{"x":55,"y":803,"value":5},{"x":474,"y":260,"value":16},{"x":764,"y":753,"value":2},{"x":926,"y":240,"value":12},{"x":491,"y":945,"value":3},{"x":987,"y":165,"value":19},{"x":996,"y":974,"value":7},{"x":879,"y":49,"value":16},{"x":219,"y":685,"value":7},{"x":927,"y":564,"value":2},{"x":933,"y":733,"value":7},{"x":205,"y":808,"value":3},{"x":241,"y":376,"value":5},{"x":316,"y":561,"value":13},{"x":759,"y":928,"value":5},{"x":628,"y":104,"value":19},{"x":54,"y":423,"value":13},{"x":96,"y":27,"value":19},{"x":471,"y":723,"value":9},{"x":420,"y":217,"value":2},{"x":943,"y":784,"value":14},{"x":991,"y":769,"value":6},{"x":187,"y":26,"value":2},{"x":387,"y":163,"value":7},{"x":471,"y":104,"value":11},{"x":806,"y":440,"value":4},{"x":922,"y":288,"value":18},{"x":480,"y":446,"value":19},{"x":400,"y":724,"value":6},{"x":165,"y":549,"value":2},{"x":906,"y":22,"value":1},{"x":876,"y":539,"value":1},{"x":5,"y":577,"value":19},{"x":220,"y":95,"value":4},{"x":493,"y":331,"value":4},{"x":771,"y":156,"value":15},{"x":140,"y":239,"value":15},{"x":326,"y":378,"value":16},{"x":714,"y":397,"value":6},{"x":823,"y":403,"value":13},{"x":373,"y":783,"value":17},{"x":935,"y":933,"value":7},{"x":674,"y":488,"value":8},{"x":253,"y":75,"value":7},{"x":52,"y":16,"value":6},{"x":52,"y":689,"value":14},{"x":253,"y":366,"value":16},{"x":24,"y":649,"value":13},{"x":323,"y":848,"value":20},{"x":583,"y":94,"value":13},{"x":829,"y":269,"value":1},{"x":264,"y":819,"value":15},{"x":859,"y":34,"value":16},{"x":661,"y":239,"value":18},{"x":212,"y":684,"value":3},{"x":202,"y":939,"value":4},{"x":398,"y":478,"value":18},{"x":728,"y":877,"value":6},{"x":462,"y":73,"value":1},{"x":310,"y":206,"value":2},{"x":130,"y":424,"value":20},{"x":593,"y":700,"value":17},{"x":867,"y":471,"value":13},{"x":140,"y":110,"value":13},{"x":459,"y":508,"value":14},{"x":38,"y":295,"value":20},{"x":53,"y":469,"value":5},{"x":461,"y":361,"value":17},{"x":844,"y":473,"value":18},{"x":706,"y":826,"value":18},{"x":8,"y":598,"value":18},{"x":782,"y":353,"value":16},{"x":74,"y":665,"value":1},{"x":32,"y":766,"value":3},{"x":641,"y":365,"value":4},{"x":144,"y":130,"value":2},{"x":694,"y":976,"value":18},{"x":833,"y":820,"value":3},{"x":533,"y":381,"value":2},{"x":242,"y":823,"value":6},{"x":133,"y":869,"value":10},{"x":870,"y":611,"value":19},{"x":563,"y":984,"value":11},{"x":421,"y":628,"value":2},{"x":659,"y":384,"value":13},{"x":261,"y":734,"value":5},{"x":262,"y":599,"value":12},{"x":936,"y":619,"value":2},{"x":286,"y":656,"value":18},{"x":991,"y":385,"value":2},{"x":43,"y":744,"value":9},{"x":77,"y":934,"value":15},{"x":528,"y":452,"value":8},{"x":20,"y":19,"value":19},{"x":757,"y":101,"value":2},{"x":263,"y":287,"value":16},{"x":71,"y":536,"value":18},{"x":575,"y":240,"value":10},{"x":509,"y":462,"value":17},{"x":90,"y":251,"value":7},{"x":402,"y":332,"value":20},{"x":96,"y":587,"value":12},{"x":192,"y":507,"value":14},{"x":567,"y":263,"value":5},{"x":824,"y":369,"value":19},{"x":122,"y":825,"value":18},{"x":835,"y":495,"value":2},{"x":296,"y":62,"value":17},{"x":362,"y":308,"value":12},{"x":984,"y":970,"value":5},{"x":575,"y":764,"value":13},{"x":291,"y":935,"value":10},{"x":742,"y":76,"value":17},{"x":626,"y":430,"value":2},{"x":924,"y":723,"value":19},{"x":352,"y":69,"value":3},{"x":813,"y":629,"value":14},{"x":192,"y":450,"value":11},{"x":852,"y":584,"value":10},{"x":556,"y":226,"value":9},{"x":687,"y":267,"value":1},{"x":135,"y":376,"value":15},{"x":287,"y":493,"value":19},{"x":286,"y":972,"value":10},{"x":224,"y":133,"value":7},{"x":605,"y":265,"value":14},{"x":688,"y":2,"value":4},{"x":595,"y":889,"value":9},{"x":603,"y":598,"value":17},{"x":698,"y":871,"value":9},{"x":544,"y":929,"value":3},{"x":236,"y":366,"value":17},{"x":243,"y":618,"value":6},{"x":824,"y":231,"value":15},{"x":986,"y":590,"value":8},{"x":743,"y":906,"value":16},{"x":641,"y":951,"value":8},{"x":953,"y":801,"value":11},{"x":14,"y":230,"value":20},{"x":185,"y":322,"value":14},{"x":421,"y":146,"value":8},{"x":886,"y":400,"value":3},{"x":403,"y":62,"value":12},{"x":942,"y":675,"value":1},{"x":349,"y":735,"value":17},{"x":878,"y":220,"value":20},{"x":817,"y":853,"value":10},{"x":781,"y":415,"value":14},{"x":21,"y":751,"value":20},{"x":990,"y":606,"value":6},{"x":445,"y":312,"value":2},{"x":946,"y":905,"value":17},{"x":536,"y":913,"value":20}]
let DEV_MODE = false;

if (DEV_MODE){
  module.exports = [getDistance,getAzimuth,getVariance,
  getDistancesForPoint,filterDistances, getDistanceMapForDataset,
  getVariogramForPoints, chunkDataAndGetResults, reduceResults,
  preparePlotData,
  variogramByMapReduce];
}


function getDistance(point1, point2){
  //for two points, return euclidean distance
  let xDistance = point2["x"] - point1["x"];
  let yDistance = point2["y"] - point1["y"];
  let distance = Math.sqrt(Math.pow(xDistance,2) + Math.pow(yDistance,2));
  return distance;
}

function getVariance(point1, point2){
  //for two points, return semivariance
  let difference = point2["value"] - point1["value"]
  let variance = Math.pow(difference,2);
  let semivariance = variance / 2;
  return semivariance;
}

function getAzimuth(point1, point2){
  //for two points, calculate azimuth of line between them
  let m = Math.atan((point2["y"] - point1["y"]) / (point2["x"] - point1["x"]));
  let angleFromX = m * 180 / Math.PI;
  if (angleFromX < 90){
    angleDegrees = 90 - angleFromX;
  } else {
    angleDegrees = 450 - angleFromX;
  }
  return angleDegrees;
}

function getDistancesForPoint(point, dataset){
    //point, whole dataset -> [ [distance,variance, azimuth],...]
    function getDistanceAndVariance(x,point){
      let distance = getDistance(x,point);
      let variance = getVariance(x,point);
      let azimuth = getAzimuth(x,point);
      //console.log(`Point1: ${x["x"]},${x["y"]}, Point2: ${point["x"]},${point["y"]}: ${[distance, variance, azimuth]}`)
      return [distance,variance,azimuth];
    }
    let distances = dataset.map(x=>getDistanceAndVariance(x,point));
    return distances;
}

function filterDistances(data, azimuth, tolerance){
  function angleBetweenAzimuths(azimuth1, azimuth2){
    let difference = Math.abs(azimuth2 - azimuth1);
    let minorAngle;
    if (difference > 180){
      minorAngle = 360 - difference;
      } else {
        minorAngle = difference;
      }
      if (minorAngle > 90){
        return 180 - minorAngle;
      } else {
        return minorAngle;
      }
    }

    return data.filter(element => (angleBetweenAzimuths(element[2],azimuth) <= tolerance))
  }

function getDistanceMapForDataset(chunkData, data, chunkMinimumInDataset){
  //get all distances and variances
  //map on chunkData
  let pointResults = chunkData.map(function (currentValue, index){
    //get only pairs for the chunk data and forward in main dataset
    //add chunkMinimum to index to get actual index of chunk entry in main dataset
    //deal with only pairs from that index forward to prevent duplicates
    return getDistancesForPoint(currentValue, data.slice(chunkMinimumInDataset + index))
  });
  //flatten list
  let flatList = [].concat.apply([],pointResults);
  return flatList;
}

function getVariogramForPoints(inputPoints, lag, lagDistance, azimuth, tolerance){
  //list of points -> [{"lagNumber":int,"lagDistance":num, "semivariance":num,"count":int}...]
  function reduceForLag(accumulator, value){
      return accumulator + value[1];
    }
  output = []
  //filter by distance
  let distanceFiltered = inputPoints.filter(element => ((element[0] > ((lag-1) * lagDistance)) && (element[0] <= (lag * lagDistance))));
  //filter by azimuth and tolerance
  //let azimuthFiltered = filterDistances(distanceFiltered, azimuth, tolerance);
  let azimuthFiltered = distanceFiltered
  //weight semivariance by count
  let valueCount = azimuthFiltered.length;
  //reduce
  let reduced = azimuthFiltered.reduce(reduceForLag, 0);
  //parse results into variogram point
  let results = {"lagNumber":lag,"lagDistance":lagDistance * lag,"semivariance":reduced/valueCount, "count":valueCount};
  return results
}

function chunkDataAndGetResults(dataset, lagDistance, numberOfLags, azimuth, tolerance, chunkSize){
  //processes dataset in chunks of max chunkSize (number of elements)
  let resultsSet = []
  //for each chunk in dataset:
  let numberOfChunks = Math.ceil(dataset.length / chunkSize);
  for (i = 0; i < numberOfChunks; i++){
    let chunkLimit;
    //check if at end of array
    if ((i+1) * chunkSize > dataset.length){
      //partial chunk, set limit to end of array
      chunkLimit = dataset.length;
    } else {
      //full chunk
      chunkLimit = (i + 1) * chunkSize;
    }
    let chunkData = dataset.slice(i * chunkSize, chunkLimit);
    let distanceMap = getDistanceMapForDataset(chunkData, dataset, i * chunkSize);
    //get data for each lag
    for (let j = 1; j <= numberOfLags; j++){
      let results = getVariogramForPoints(distanceMap, j, lagDistance, azimuth, tolerance);
      resultsSet.push(results);
    }
  }
  return resultsSet
}

function reduceResults(acc, resultsForLag){
    //add weighted results average for lag to accumulator for lag
    let key = String(resultsForLag["lagNumber"])
    if (!acc[key]){
      acc[key] = {"count":0,"semivariance":0}
    }
    if (resultsForLag["count"] == 0){
      //no results to accumulate
      return acc
    } else {
      if (acc[key]["semivariance"] == 0){
        //no data yet, use results
        acc[key]["semivariance"] = resultsForLag["semivariance"]
      } else {
        //get semivariances weighted by count and sum
        acc[key]["semivariance"] = (
          acc[key]["semivariance"] * acc[key]["count"] +
          resultsForLag["semivariance"] * resultsForLag["count"])
          /(resultsForLag["count"] + acc[key]["count"]
        );
      }
      acc[key]["count"] = acc[key]["count"] + resultsForLag["count"];
      return acc
    }
}
function preparePlotData(variogram){
  //prepare for plotting
  let plotOutput = {"lagNumber":[],"lagDistance":[],"semivariance":[],"countPerLag":[]};
  for (const [key,value] of Object.entries(variogram)){
    plotOutput["lagNumber"].push(key);
    plotOutput["lagDistance"].push(value["lagDistance"]);
    plotOutput["semivariance"].push(value["semivariance"]);
    plotOutput["countPerLag"].push(value["count"])
  }
  return plotOutput;
}

function variogramByMapReduce(dataset, lagDistance, numberOfLags, azimuth, tolerance, chunkSize){
  let resultsSet = chunkDataAndGetResults(dataset, lagDistance, numberOfLags, azimuth, tolerance, chunkSize);
  //reduce results list by weighted average for all lags

  let accumulator = {}
  for (i=1;i <= numberOfLags;i++){
    accumulator[String(i)] = {"lagDistance":i*lagDistance,"count":0,"semivariance":0}
  }
  let output = resultsSet.reduce(reduceResults, accumulator);
  return output;
}
//testing
//console.log(calculateVariogram(testDataBig, 50, 5, 0, 5))
//let point1 = {"x":50,"y":-50,"value":"50"}
//let point2 = {"x":-60,"y":80,"value":"10"}
//console.log(getAzimuth(point1,point2))

function calculateVariogram(data, lagDistance, numberOfLags, azimuth, tolerance){
  //data: json object with keys for x, y, and value
  //lagDistance: length of each bin
  //numberOfLags: max number of lags to use
  //returns list of json objects:
  //[{lagNumber, lagDistance, semivariance}...]
  //for each data point:
  //map distance and variance to all other data points
  let chunkSize = 500;
  //validate input
  dummyData = {"x":[],"y":[],"value":[]}
  if (data.size == 0 || lagDistance < 0 || numberOfLags < 0 || azimuth > 360 || azimuth < 0 || tolerance > 360){
      return dummyData;
  }
  let output = variogramByMapReduce(data, lagDistance, numberOfLags, azimuth, tolerance,chunkSize)
  let plotOutput = preparePlotData(output)
  return plotOutput;
}

function loadData(string){
  let dataObject = []
  const regex = /\r/;
  let filteredArray = string.replace(regex, '')
  let stringArray = string.split(/\n/);
  let dataArray = stringArray.map(x=>x.split(","))
  dataArray.forEach(element => dataObject.push({"x":element[0],"y":element[1],"value":element[2]}))
  variogramDisplay.updatePoints(dataObject.slice(1))
}

function makeMapFromPoints(points){
  //return {"x":[...],"y":[...],"value":[...]}
  function assignValues(element){
    xList.push(element["x"]);
    yList.push(element["y"]);
    valueList.push(element["value"]);
  }
  xList = []
  yList = []
  valueList = []
  points.forEach(assignValues);
  return {"x":xList,"y":yList,"value":valueList}
}

if (!DEV_MODE){
document.querySelector("#read-button").addEventListener('click', function(){
  let file = document.querySelector("#file-input").files[0];
  let reader = new FileReader();
  reader.addEventListener('load', function(e){
    let text = e.target.result;
    loadData(text);
  })
  reader.readAsText(file);
})


var variogramDisplay = new Vue({
  el: "#appDisplay",
  data: {
    pointData: [{"x":0,"y":0,"value":0}],
    mapData: {"x":[0],"y":[0],"value":[10]},
    lagDistance: 0,
    numberOfLags: 0,
    azimuth: 0,
    tolerance: 360,
    results: {"numberOfLags":0,"lagDistance":0,"semivariance":0,"countPerLag":0},
    sillVariance : 0
  },
  methods: {
    updateLag: function (){
      let results = calculateVariogram(this.pointData,this.lagDistance, this.numberOfLags, this.azimuth, this.tolerance)
      this.results = results
      renderPlot(results)
      renderHistogram(results)
  },
    updatePoints: function (newPoints){
      this.pointData = newPoints;
      this.mapData = makeMapFromPoints(newPoints);
      renderMap(this.mapData)
      this.updateLag;
    }
}
})

function renderPlot(data){
  let plotData = {
    x: data["lagDistance"],
    y: data["semivariance"],
    type:'scatter'
  };
  let layout = {margin:{t:25,l:25,r:25,b:25}}
  let config = {responsive: true}
  divPlot = document.getElementById('plotDiv');
  Plotly.newPlot(divPlot,[plotData], layout, config)
}

function renderHistogram(data){
  let histogramData = {
    x: data["lagDistance"],
    y: data["countPerLag"],
    type:'bar'
  }
  let layout = {margin:{t:25,l:25,r:25,b:25}}
  let config = {responsive: true}
  divPlot = document.getElementById('histoDiv');
  Plotly.newPlot(divPlot,[histogramData], layout, config)
}

function renderMap(data){
  let plotData = {
    x: data["x"],
    y: data["y"],
    mode: 'markers',
    marker: {
      size:4,
      color:data["value"]
    }
  }
  let layout = {margin:{t:30,l:30,r:30,b:30}}
  let config = {responsive: true}
  divPlot = document.getElementById('mapDiv');
  Plotly.newPlot(divPlot,[plotData],layout,config)
}
}
